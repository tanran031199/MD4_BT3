CREATE SCHEMA QUAN_LY_BAN_HANG;

USE QUAN_LY_BAN_HANG;

CREATE TABLE CUSTOMERS
(
    ID   INT         NOT NULL AUTO_INCREMENT PRIMARY KEY,
    NAME VARCHAR(40) NOT NULL,
    AGE  INT(3)      NOT NULL
);

CREATE TABLE ORDERS
(
    ID           INT NOT NULL AUTO_INCREMENT PRIMARY KEY,
    CUSTOMNER_ID INT,
    ORDER_DATE   DATE,
    TOTAL_PRICE  DOUBLE,
    CONSTRAINT FK_CUSTOMER FOREIGN KEY (CUSTOMNER_ID) REFERENCES CUSTOMERS (ID)
);

CREATE TABLE PRODUCT
(
    ID    INT NOT NULL AUTO_INCREMENT PRIMARY KEY,
    NAME  VARCHAR(40),
    PRICE DOUBLE
);

CREATE TABLE ORDER_DETAIL
(
    ORDER_ID   INT,
    PRODUCT_ID INT,
    ORDER_QTY  INT,
    PRIMARY KEY (ORDER_ID, PRODUCT_ID),
    CONSTRAINT FK_ORDER FOREIGN KEY (ORDER_ID) REFERENCES ORDERS (ID),
    CONSTRAINT FK_PRODUCT FOREIGN KEY (PRODUCT_ID) REFERENCES PRODUCT (ID)
);

INSERT INTO CUSTOMERS
    VALUE (1, 'Minh Quan', 10),
    (2, 'Ngoc Oanh', 20),
    (3, 'Hong Ha', 50);

INSERT INTO ORDERS
    VALUE (1, 1, STR_TO_DATE('2006-03-21', '%Y-%m-%d'), NULL),
    (2, 2, STR_TO_DATE('2006-03-23', '%Y-%m-%d'), NULL),
    (3, 1, STR_TO_DATE('2006-03-16', '%Y-%m-%d'), NULL);

INSERT INTO PRODUCT
    VALUE (1, 'May Giat', 3),
    (2, 'Tu Lanh', 5),
    (3, 'Dieu Hoa', 7),
    (4, 'Quat', 1),
    (5, 'Bep Dien', 2);

INSERT INTO ORDER_DETAIL
    VALUE (1, 1, 3),
    (1, 3, 7),
    (1, 4, 2),
    (2, 1, 1),
    (3, 1, 8),
    (2, 5, 4),
    (2, 3, 3);

SELECT ID, ORDER_DATE, TOTAL_PRICE
FROM ORDERS;

SELECT C.NAME AS CUSTOMER_NAME, P.NAME AS PRODUCT_NAME, O.ORDER_DATE
FROM CUSTOMERS AS C
         JOIN ORDERS AS O ON C.ID = O.CUSTOMNER_ID
         JOIN ORDER_DETAIL AS OD on O.ID = OD.ORDER_ID
         JOIN PRODUCT AS P ON P.ID = OD.PRODUCT_ID;

SELECT NAME,
       CASE
           WHEN ID NOT IN (SELECT CUSTOMNER_ID FROM ORDERS) THEN 'Chưa mua sản phẩm nào'
           ELSE 'Đã mua sản phẩm'
           END AS HAS_ORDERS
FROM CUSTOMERS;

UPDATE ORDERS AS O
SET TOTAL_PRICE = (SELECT SUM((P.PRICE * ORDER_QTY))
                   FROM ORDER_DETAIL AS OD
                            JOIN PRODUCT P on P.ID = OD.PRODUCT_ID
                   WHERE O.ID = OD.ORDER_ID
                   GROUP BY ORDER_ID)

WHERE ID IN (SELECT DISTINCT ORDER_ID FROM ORDER_DETAIL);

SELECT ID, ORDER_DATE, TOTAL_PRICE
FROM ORDERS;

SELECT *
FROM PRODUCT;

SELECT *
FROM CUSTOMERS;

SELECT *
FROM ORDERS;

SELECT *
FROM ORDER_DETAIL;